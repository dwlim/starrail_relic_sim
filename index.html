<!DOCTYPE html>
<html>
<body>

<button onclick="rollRelics()">Roll Relics</button>

<div id="relic_output"></div>
<pre id="relic_results"></pre>

</body>
</html>


<script>
  var relics = []
  let pieces = ["Hat", "Glove", "Body", "Boots"]; //, "Orb", "Rope"];
  let main_stat = 
    [[["Hp"], [1]], 
    [["Atk"], [1]], 
    [["Hp%", "Atk%", "Def%", "CR", "CD", "Heal", "EHR", "ER"], [20, 20, 20, 10, 10, 10, 10]], 
    [["Hp", "Atk", "Def", "Spd"], [27.5, 30, 30, 12.5]]];

  let sub_stat = ["Hp", "Atk", "Def", "Hp%", "Atk%", "Def%", "Spd", "CR", "CD", "EHR", "ER", "BE"];
  let sub_weight = 
  [[[0, 11, 11, 11, 11, 11, 5, 6.5, 6.5, 9, 9, 9]],
    [[11, 0, 11, 11, 11, 11, 5, 6.5, 6.5, 9, 9, 9]], 
    [[11, 11, 11, 0, 11, 11, 5, 6.5, 6.5, 9, 9, 9], 
    [11, 11, 11, 11, 0, 11, 5, 6.5, 6.5, 9, 9, 9], 
    [11, 11, 11, 11, 11, 0, 5, 6.5, 6.5, 9, 9, 9],
    [10.53, 10.53, 10.53, 10.53, 10.53, 10.53, 4.78, 0, 6.22, 8.61, 8.61, 8.61],
    [10.53, 10.53, 10.53, 10.53, 10.53, 10.53, 4.78, 6.22, 0, 8.61, 8.61, 8.61],
    [9.91, 9.91, 9.91, 9.91, 9.91, 9.91, 4.5, 5.86, 5.86, 8.11, 8.11, 8.11],
    [10.78, 10.78, 10.78, 10.78, 10.78, 10.78, 4.9, 6.37, 6.37, 0, 8.82, 8.82]
    ], 
    [[11, 11, 11, 0, 11, 11, 5, 6.5, 6.5, 9, 9, 9],
    [11, 11, 11, 11, 0, 11, 5, 6.5, 6.5, 9, 9, 9],
    [11, 11, 11, 11, 11, 0, 5, 6.5, 6.5, 9, 9, 9],
    [10.38, 10.38, 10.38, 10.38, 10.38, 10.38, 0, 6.13, 6.13, 8.49, 8.49, 8.49]]]

  let sub_values = 
    [[33.87, 38.103755, 42.33751],
      [16.935, 19.051877, 21.168754],
      [16.935, 19.051877, 21.168754],
      [3.456, 3.888, 4.32],
      [3.456, 3.888, 4.32],
      [4.32, 4.86, 5.4],
      [2, 2.3, 2.6],
      [2.592, 2.916, 3.24],
      [5.184, 5.832, 6.48],
      [3.456, 3.888, 4.32],
      [3.456, 3.888, 4.32],
      [5.184, 5.832, 6.48]]

  function buildUI() {
    document.getElementById("relic_output").innerHTML = "";
    for (const element of relics) {
      const tbl = document.createElement('table');
      const title_header = tbl.insertRow();
      title_header.innerHTML = "<b>" + element.name + " of Set " + element.set + "</b>"
      const main_header = tbl.insertRow();
      main_header.innerHTML = "<b>Main Stat:</b>"
      const main_tr = tbl.insertRow();
      const main_td1 = main_tr.insertCell();
      const main_td2 = main_tr.insertCell();
      main_td1.innerHTML = element.main_stat;

      const sub_header = tbl.insertRow();
      sub_header.innerHTML = "<b>Sub Stats:</b>"
      for (const substat of element.sub_stats) {
        if (substat.show == true) {
          const tr = tbl.insertRow();
          const td1 = tr.insertCell();
          const td2 = tr.insertCell();

          td1.innerHTML = substat.stat;
          td2.innerHTML = substat.value;
        }
      }
      const btn = document.createElement('button');
      btn.textContent = "Level Relic";
      btn.onclick = function() {levelRelics(element);}
      document.getElementById("relic_output").appendChild(btn);
      document.getElementById("relic_output").appendChild(tbl);


    }
  }

  function refreshUI() {
    document.getElementById("relic_results").innerHTML = JSON.stringify(relics, undefined, 2);
  }

  function rollRelics() {
    relics.length = 0;
    generateRelic();
    buildUI();
  }

  function levelRelics(element) {
    if (element.level >= 15){
      return;
    }
    if (element.sub_stats[3].show == false) {
      element.sub_stats[3].show = true;
    } else {
      let sub_index = Math.floor(Math.random() * 3);
      let level_increment = sub_values[element.sub_stats[sub_index].index][Math.floor(Math.random()*3)];
      element.sub_stats[sub_index].value += level_increment;
    }
    element.level += 3;
    buildUI();
  }

  function weighted_random(items, weights) {
    var i;

    for (i = 1; i < weights.length; i++)
        weights[i] += weights[i - 1];
    
    var random = Math.random() * weights[weights.length - 1];
    
    for (i = 0; i < weights.length; i++)
        if (weights[i] > random)
            break;
    
    return items[i];
  }

  function accumulate(numbers) {
    let accm  = [];
    let total = 0;
    for (let n of numbers) {
        total += n;
        accm.push(total)
    }
    return accm;
  }

  function bisect_left(arr, target) {
    let n = arr.length;
    let l = 0;
    let r = n - 1;
    while (l <= r) {
        let m = Math.floor((l + r) / 2);
        if (arr[m] < target) {
            l = m + 1;
        } else if (arr[m] >= target) {
            r = m - 1;
        } 
    }
    return l;
  }

  function wchoice(population, weights, accumulated) {
    let acm = (accumulated) ? weights : accumulate(weights);
    let rnd = Math.random() * acm[acm.length - 1];

    let idx = bisect_left(acm, rnd);

    return [idx, population[idx]];
  }

  function wsample(population, weights, k) {
    let sample  = [];
    let indices = [];
    let index   = 0;
    let choice  = null;
    let acmwts  = accumulate(weights);

    for (let i=0; i < k; i++) {
        [index, choice] = wchoice(population, acmwts, true);
        sample.push(choice);
        indices.push(index);

        // The below updates the accumulated weights as if the member
        // at `index` has a weight of 0, eliminating it from future draws.
        // This portion could be optimized. See note below.
        let ndecr = weights[index];
        for (; index < acmwts.length; index++) {
            acmwts[index] -= ndecr;
        }
    }
    return [indices, sample];
  }

  function generateRelic() {
    let num_pieces = Math.random() < 0.108 ? 3 : 2;

    for (let i = 0; i < num_pieces; i++) {
      var item = {};

      let piece = Math.floor(Math.random() * pieces.length);
      item.name = pieces[piece];
      item.main_stat = weighted_random(main_stat[piece][0], main_stat[piece][1]);
      item.sub_stats = [];
      item.level = 0;

      let main_index = main_stat[piece][0].indexOf(item.main_stat);
      let sub = wsample(sub_stat, sub_weight[piece][main_index], 4);
      for (let i=0; i < sub[0].length; i++) {
        var subs = {};
        subs.stat = sub[1][i];
        subs.index = sub[0][i];
        subs.value = sub_values[sub[0][i]][Math.floor(Math.random()*3)];
        subs.show = i==3 && Math.random() < .8 ? false : true;
        item.sub_stats.push(subs);
      }
      item.set = Math.random() < .5 ? "1" : "2";
      console.log(item);
      relics.push(item);
    }
  }

  </script>